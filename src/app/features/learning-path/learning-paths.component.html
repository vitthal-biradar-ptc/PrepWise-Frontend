<div class="learning-paths-container">
  <app-header></app-header>

  <div class="main-content">
    <div class="header-section">
      <h1 class="page-title">Learning Paths</h1>

      @if (userId) {
      <p class="subtitle">Showing results for user: {{ userId }}</p>
      }

      <!-- Generate Button -->
      @if (userId) {
      <div>
        <button class="cta-button generate-btn" (click)="openGeneratorModal()">
          Generate New Learning Path
        </button>
      </div>
      }
    </div>

    <!-- Modal: Generate Learning Path -->
    @if (showGeneratorModal) {
    <div
      class="modal-backdrop"
      (click)="closeGeneratorModal()"
      (keydown.escape)="closeGeneratorModal()"
      tabindex="-1"
    >
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="generatorTitle"
        (click)="$event.stopPropagation()"
      >
        <div class="modal-header">
          <h2 id="generatorTitle">Generate New Learning Path</h2>
          <button
            class="icon-button"
            (click)="closeGeneratorModal()"
            [disabled]="generationLoading"
            aria-label="Close"
          >
            ✕
          </button>
        </div>

        <form class="modal-form" (ngSubmit)="generateNewPath()" novalidate>
          <div class="field">
            <label for="skill">Skill</label>
            <input
              id="skill"
              type="text"
              [(ngModel)]="newSkill"
              name="skill"
              placeholder="e.g., MERN Stack"
              required
              autofocus
            />
          </div>

          <div class="field">
            <label for="level">Level</label>
            <select id="level" [(ngModel)]="newLevel" name="level" required>
              <option value="" disabled>Select level</option>
              <option>Beginner</option>
              <option>Intermediate</option>
              <option>Advanced</option>
            </select>
          </div>

          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              (click)="closeGeneratorModal()"
              [disabled]="generationLoading"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="cta-button"
              [disabled]="generationLoading || !newSkill || !newLevel"
            >
              {{ generationLoading ? "Generating..." : "Generate" }}
            </button>
          </div>

          @if (!generationLoading && generationError) {
          <div class="state error">Error: {{ generationError }}</div>
          }
        </form>
      </div>
    </div>
    }

    <!-- Delete Confirmation Modal -->
    @if (deleteTarget) {
    <div
      class="modal-backdrop"
      (click)="closeDeleteModal()"
      (keydown.escape)="closeDeleteModal()"
      tabindex="-1"
    >
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="deleteTitle"
        (click)="$event.stopPropagation()"
      >
        <div class="modal-header">
          <h2 id="deleteTitle">Delete Learning Path</h2>
          <button
            class="icon-button"
            (click)="closeDeleteModal()"
            [disabled]="deleteTarget && deletingIds.has(deleteTarget.id)"
            aria-label="Close"
          >
            ✕
          </button>
        </div>

        <div class="modal-form">
          <p>
            Are you sure you want to delete “{{ deleteTarget.title }}”? This
            action cannot be undone.
          </p>

          @if (deleteError) {
          <div class="state error">Error: {{ deleteError }}</div>
          }

          <div class="modal-actions">
            <button
              type="button"
              class="btn-secondary"
              (click)="closeDeleteModal()"
              [disabled]="deleteTarget && deletingIds.has(deleteTarget.id)"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn-danger"
              (click)="confirmDelete()"
              [disabled]="deleteTarget && deletingIds.has(deleteTarget.id)"
            >
              {{
                deleteTarget && deletingIds.has(deleteTarget.id)
                  ? "Deleting..."
                  : "Delete"
              }}
            </button>
          </div>
        </div>
      </div>
    </div>
    } @if (loading) {
    <div class="state">Loading learning paths...</div>
    } @if (!loading && error) {
    <div class="state error">Error: {{ error }}</div>
    } @if (!loading && !error && paths.length === 0) {
    <div class="state empty">No learning paths found.</div>
    } @if (!loading && !error && paths.length) {
    <div class="grid">
      <div
        class="card"
        *ngFor="let lp of paths; trackBy: trackById"
        (click)="openPath(lp)"
        tabindex="0"
        (keydown.enter)="openPath(lp)"
        (keydown.space)="openPath(lp)"
        role="button"
        [attr.aria-label]="'Open ' + getTitle(lp)"
      >
        <!-- Delete icon button (top-right) -->
        <button
          type="button"
          class="card-delete-btn"
          (click)="openDeleteModal(lp, $event)"
          [disabled]="deletingIds.has(getId(lp))"
          [attr.aria-label]="'Delete ' + getTitle(lp)"
          title="Delete"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path
              fill="currentColor"
              d="M15.5 4l-1-1h-5l-1 1H5v2h14V4h-3.5zM6 7v12a2 2 0 002 2h8a2 2 0 002-2V7H6zm3.5 3h1.5v8H9.5v-8zm3.5 0h1.5v8H13v-8z"
            />
          </svg>
        </button>

        <div class="card-title">{{ getTitle(lp) }}</div>

        @if (lp.description) {
        <div class="card-desc">
          {{ lp.description }}
        </div>
        } @else {
        <div class="card-desc muted">No description</div>
        }

        <div class="card-footer">
          <!-- Removed Delete text button -->
          <a
            class="open-link"
            [routerLink]="['/learning-path', userId, getId(lp)]"
            (click)="$event.preventDefault(); openPath(lp)"
            >Open ↗</a
          >
        </div>
      </div>
    </div>
    }
  </div>
</div>

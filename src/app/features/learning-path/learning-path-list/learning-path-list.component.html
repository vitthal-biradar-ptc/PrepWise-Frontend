<div class="learning-paths-container">
  <app-header></app-header>

  <div class="main-content">
    <!-- Header Section -->
    <div class="header-section">
      <div class="title-section">
        <h1 class="page-title">Learning Paths</h1>
        <p class="subtitle">
          Structured learning journeys to master your skills
        </p>
      </div>

      <div class="header-actions">
        <div class="search-bar">
          <i class="search-icon">🔍</i>
          <input
            type="text"
            placeholder="Search learning paths..."
            [(ngModel)]="searchTerm"
            (input)="onSearch()"
            class="search-input"
          />
          <button
            *ngIf="searchTerm"
            (click)="clearSearch()"
            class="clear-btn"
            title="Clear search"
          >
            ×
          </button>
        </div>
        <button class="cta-button primary" (click)="openGeneratorModal()">
          <span class="btn-icon">✨</span>
          <span>Generate New Path</span>
        </button>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-chips">
        <button
          class="chip"
          [class.active]="selectedCategory === ''"
          (click)="filterByCategory(null)"
        >
          All Paths
        </button>
        <button
          class="chip"
          [class.active]="selectedCategory === 'In Progress'"
          (click)="filterByCategory('In Progress')"
        >
          In Progress
        </button>
        <button
          class="chip"
          [class.active]="selectedCategory === 'Completed'"
          (click)="filterByCategory('Completed')"
        >
          Completed
        </button>
      </div>
      <div class="sort-section">
        <select
          class="sort-select"
          [(ngModel)]="selectedSort"
          (change)="onSortChange($event)"
        >
          <option value="recent">Sort by: Recently Created</option>
          <option value="title-asc">Sort by: Title A-Z</option>
          <option value="title-desc">Sort by: Title Z-A</option>
          <option value="difficulty">Sort by: Difficulty</option>
          <option value="duration">Sort by: Duration</option>
        </select>
      </div>
    </div>

    <!-- Active Filters Indicator -->
    <div *ngIf="hasActiveFilters && !loading" class="active-filters">
      <div class="filter-info">
        <span class="results-count"
          >{{ filteredCount }} of {{ paths.length }} paths</span
        >
        <div class="active-filter-tags">
          <span *ngIf="searchTerm" class="filter-tag">
            Search: "{{ searchTerm }}"
            <button (click)="clearSearch()" class="remove-filter">×</button>
          </span>
          <span *ngIf="selectedCategory" class="filter-tag">
            Category: {{ selectedCategory }}
            <button (click)="filterByCategory(null)" class="remove-filter">
              ×
            </button>
          </span>
        </div>
      </div>
      <button class="clear-all-filters" (click)="clearAllFilters()">
        Clear All
      </button>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="state loading-state">
      <div class="loading-grid">
        <div class="skeleton-card" *ngFor="let item of [1, 2, 3, 4, 5, 6]">
          <div class="skeleton-header"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line short"></div>
          <div class="skeleton-footer"></div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="state error-state">
      <div class="state-content">
        <div class="state-icon error-icon">⚠️</div>
        <h3 class="state-title">Unable to load learning paths</h3>
        <p class="state-message">{{ error }}</p>
        <button class="retry-btn" (click)="fetchLearningPaths(userId)">
          <span class="btn-icon">🔄</span>
          Try Again
        </button>
      </div>
    </div>

    <!-- Empty State -->
    <div
      *ngIf="!loading && !error && paths.length === 0"
      class="state empty-state"
    >
      <div class="state-content">
        <div class="state-icon empty-icon">📚</div>
        <h3 class="state-title">No learning paths yet</h3>
        <p class="state-message">
          Create your first learning path to get started on your journey
        </p>
        <button class="cta-button primary" (click)="openGeneratorModal()">
          <span class="btn-icon">✨</span>
          Create Your First Path
        </button>
      </div>
    </div>

    <!-- No Results State -->
    <div
      *ngIf="
        !loading && !error && paths.length > 0 && filteredPaths.length === 0
      "
      class="state empty-state"
    >
      <div class="state-content">
        <div class="state-icon empty-icon">🔍</div>
        <h3 class="state-title">No matching paths found</h3>
        <p class="state-message">Try adjusting your search terms or filters</p>
        <button class="cta-button primary" (click)="clearAllFilters()">
          Clear All Filters
        </button>
      </div>
    </div>

    <!-- Learning Paths Grid -->
    <div
      *ngIf="!loading && !error && filteredPaths.length > 0"
      class="paths-section"
    >
      <div class="section-header">
        <h2 class="section-title">
          {{ hasActiveFilters ? "Filtered" : "Your" }} Learning Paths
        </h2>
        <span class="count-badge">{{ filteredPaths.length }}</span>
      </div>

      <div class="paths-grid">
        <div
          *ngFor="let path of filteredPaths; trackBy: trackById"
          class="path-card"
          (click)="openPath(path)"
          [attr.tabindex]="0"
          (keydown.enter)="openPath(path)"
          (keydown.space)="openPath(path)"
        >
          <!-- Card Header -->
          <div class="card-header">
            <div class="card-badges">
              <span
                class="difficulty-badge"
                [class]="path.level?.toLowerCase()"
              >
                {{ path.level || "Beginner" }}
              </span>
              <span class="duration-badge">{{
                path.duration || "medium-term"
              }}</span>
            </div>
            <button
              class="delete-btn"
              (click)="openDeleteModal(path, $event)"
              [disabled]="deletingIds.has(getId(path))"
              [attr.aria-label]="'Delete ' + getTitle(path)"
            >
              <span *ngIf="!deletingIds.has(getId(path))">🗑️</span>
              <span *ngIf="deletingIds.has(getId(path))" class="loading-spinner"
                >⏳</span
              >
            </button>
          </div>

          <!-- Card Content -->
          <div class="card-content">
            <h3 class="card-title">{{ getTitle(path) }}</h3>
            <p class="card-description">
              {{
                path.description ||
                  "Level: " +
                    (path.level || "Beginner") +
                    " • Duration: " +
                    (path.duration || "medium-term")
              }}
            </p>
          </div>

          <!-- Card Stats -->
          <div class="card-stats">
            <div class="stat-item">
              <span class="stat-icon">📖</span>
              <span class="stat-text"
                >{{ path.learningPeriods?.length || 0 }} modules</span
              >
            </div>
            <div class="stat-item">
              <span class="stat-icon">⏱️</span>
              <span class="stat-text">{{
                getDurationText(path.duration)
              }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-icon">🎯</span>
              <span class="stat-text">{{ path.level || "Beginner" }}</span>
            </div>
          </div>

          <!-- Card Footer -->
          <div class="card-footer">
            <div class="progress-section">
              <div class="progress-label">
                <span>Progress</span>
                <span class="progress-percent"
                  >{{ getProgressPercentage(path) }}%</span
                >
              </div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  [style.width.%]="getProgressPercentage(path)"
                ></div>
              </div>
              <div class="progress-details">
                <span
                  class="progress-status"
                  [class]="
                    getProgressStatus(path).toLowerCase().replace(' ', '-')
                  "
                >
                  {{ getProgressStatus(path) }}
                </span>
              </div>
            </div>
            <div class="card-actions">
              <button class="action-btn secondary">View Details</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Generator Modal -->
  <div
    *ngIf="showGeneratorModal"
    class="modal-backdrop"
    (click)="closeGeneratorModal()"
  >
    <div class="modal modern-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-section">
          <h3 class="modal-title">Generate Learning Path</h3>
          <p class="modal-subtitle">Create a personalized learning journey</p>
        </div>
        <button
          class="close-btn"
          (click)="closeGeneratorModal()"
          [disabled]="generationLoading"
        >
          <span class="close-icon">×</span>
        </button>
      </div>

      <form class="modal-form" (ngSubmit)="generateNewPath()">
        <div class="form-section">
          <div class="input-group">
            <label for="skill" class="input-label">Skill or Technology *</label>
            <input
              id="skill"
              type="text"
              [(ngModel)]="newSkill"
              name="skill"
              placeholder="e.g., React, Python, Machine Learning"
              class="form-input"
              required
              [disabled]="generationLoading"
            />
          </div>

          <div class="input-group">
            <label for="level" class="input-label">Experience Level *</label>
            <select
              id="level"
              [(ngModel)]="newLevel"
              name="level"
              class="form-select"
              required
              [disabled]="generationLoading"
            >
              <option value="">Choose your level</option>
              <option value="Beginner">Beginner - New to this skill</option>
              <option value="Intermediate">
                Intermediate - Some experience
              </option>
              <option value="Advanced">Advanced - Experienced user</option>
            </select>
          </div>
        </div>

        <!-- Success/Error Messages -->
        <div *ngIf="generationSuccess" class="alert success">
          <span class="alert-icon">✅</span>
          <span>{{ generationSuccess }}</span>
        </div>

        <div *ngIf="generationError" class="alert error">
          <span class="alert-icon">❌</span>
          <span>{{ generationError }}</span>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            class="btn secondary"
            (click)="closeGeneratorModal()"
            [disabled]="generationLoading"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn primary"
            [disabled]="!newSkill || !newLevel || generationLoading"
          >
            <span *ngIf="!generationLoading" class="btn-icon">✨</span>
            <span *ngIf="generationLoading" class="loading-spinner">⏳</span>
            <span>{{
              generationLoading ? "Generating..." : "Generate Path"
            }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div *ngIf="deleteTarget" class="modal-backdrop" (click)="closeDeleteModal()">
    <div class="modal delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-section">
          <h3 class="modal-title">Delete Learning Path</h3>
          <p class="modal-subtitle">This action cannot be undone</p>
        </div>
      </div>

      <div class="modal-content">
        <div class="delete-warning">
          <div class="warning-icon">🗑️</div>
          <p>
            Are you sure you want to delete
            <strong>"{{ deleteTarget.title }}"</strong>?
          </p>
          <p class="warning-text">
            All progress and data associated with this learning path will be
            permanently removed.
          </p>
        </div>

        <div *ngIf="deleteError" class="alert error">
          <span class="alert-icon">❌</span>
          <span>{{ deleteError }}</span>
        </div>
      </div>

      <div class="modal-actions">
        <button
          type="button"
          class="btn secondary"
          (click)="closeDeleteModal()"
          [disabled]="deletingIds.has(deleteTarget.id)"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn danger"
          (click)="confirmDelete()"
          [disabled]="deletingIds.has(deleteTarget.id)"
        >
          <span *ngIf="!deletingIds.has(deleteTarget.id)" class="btn-icon"
            >🗑️</span
          >
          <span *ngIf="deletingIds.has(deleteTarget.id)" class="loading-spinner"
            >⏳</span
          >
          <span>{{
            deletingIds.has(deleteTarget.id) ? "Deleting..." : "Delete Path"
          }}</span>
        </button>
      </div>
    </div>
  </div>

  <app-footer></app-footer>
</div>

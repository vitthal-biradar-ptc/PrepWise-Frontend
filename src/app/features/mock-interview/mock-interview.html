@if (currentView === AppView.SETUP || currentView === AppView.REPORT) {
<app-header></app-header>
}

<div class="min-h-[70vh] w-full flex flex-col items-center p-4 theme-dark-bg">
  <!-- Decorative gradient bubbles like hero -->
  <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
    <div
      class="absolute top-1/4 -left-40 w-96 h-96 bg-[#7F00FF]/20 rounded-full blur-[100px]"
    ></div>
    <div
      class="absolute bottom-1/3 -right-40 w-96 h-96 bg-[#C400FF]/20 rounded-full blur-[100px]"
    ></div>
    <div
      class="absolute -bottom-20 left-1/4 w-64 h-64 bg-[#B03EFF]/10 rounded-full blur-[80px]"
    ></div>
  </div>

  <!-- Header -->
  <div class="w-full max-w-6xl mx-auto mb-4 px-2">
    <h2 class="text-3xl font-bold theme-gradient-text">AI Mock Interview</h2>
    <p class="theme-muted">
      Practice with tailored questions and get a performance report.
    </p>
  </div>

  <div class="w-full max-w-6xl rounded-xl p-2 min-h-screen">
    <!-- SETUP VIEW -->
    @if (currentView === AppView.SETUP) {
    <div class="w-full max-w-lg mx-auto theme-card p-6">
      <h3 class="text-xl font-bold text-center mb-2 theme-light">
        Prepare for your Interview
      </h3>
      <p class="text-center text-sm theme-muted mb-5">
        Enter your role and level to tailor the conversation.
      </p>
      <form (ngSubmit)="startInterviewFromSetup()" class="space-y-6">
        <div>
          <label class="block text-sm font-semibold mb-2 theme-light"
            >Job Role *</label
          >
          <input
            type="text"
            [(ngModel)]="jobRole"
            name="role"
            placeholder="Enter your job role"
            required
            class="w-full border-2 border-[#3498DB]/20 bg-white text-[#2C3E50] rounded-lg py-3 px-4 text-base placeholder-gray-400 transition-all duration-200 focus:border-[#3498DB] focus:ring-2 focus:ring-[#3498DB]/20 focus:outline-none"
          />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2 theme-light"
            >Experience Level *</label
          >
          <div class="relative">
            <select
              [(ngModel)]="experienceLevel"
              name="experience"
              class="w-full border-2 border-[#3498DB]/20 bg-white text-[#2C3E50] rounded-lg py-3 px-4 text-base appearance-none transition-all duration-200 focus:border-[#3498DB] focus:ring-2 focus:ring-[#3498DB]/20 focus:outline-none cursor-pointer"
            >
              <option value="" disabled>Select your experience level</option>
              <option value="Entry-Level">Entry-Level (0-2 years)</option>
              <option value="Mid-Level">Mid-Level (2-5 years)</option>
              <option value="Senior">Senior (5+ years)</option>
              <option value="Lead / Principal">
                Lead / Principal (8+ years)
              </option>
            </select>
            <div
              class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none"
            >
              <svg
                class="w-5 h-5 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                ></path>
              </svg>
            </div>
          </div>
        </div>
        <button
          type="submit"
          [disabled]="!jobRole.trim()"
          class="w-full py-3 rounded-md theme-gradient-btn disabled:bg-gray-400 disabled:opacity-60"
        >
          Start Interview
        </button>
      </form>
    </div>
    }

    <!-- INTERVIEW VIEW -->
    @if (currentView === AppView.INTERVIEW) {
    <div class="w-full grid grid-cols-5 gap-2" style="height: 70vh">
      <!-- Left Panel: Video -->
      <div
        class="col-span-3 rounded-l-xl flex flex-col relative overflow-hidden theme-card"
      >
        <div class="w-full h-full flex-grow relative">
          <video
            #cameraVideo
            autoplay
            muted
            class="w-full h-full object-cover"
          ></video>
          @if (!cameraStream) {
          <div
            class="absolute inset-0 flex flex-col items-center justify-center gap-2 text-gray-300"
          >
            <div
              class="w-12 h-12 rounded-md border flex items-center justify-center"
            >
              📷
            </div>
            <span class="text-sm">Camera</span>
            <!-- placeholder to preserve structure -->
            @if (cameraError) {
            <p class="text-xs text-red-500">{{ cameraError }}</p>
            }
          </div>
          }
        </div>

        <div
          class="absolute bottom-0 left-0 right-0 h-20 flex items-center justify-center"
          style="
            background: linear-gradient(
              to top,
              rgba(0, 0, 0, 0.6),
              transparent
            );
          "
        >
          <button
            (click)="toggleListening()"
            [disabled]="aiStatus !== 'idle'"
            class="w-16 h-16 rounded-full flex items-center justify-center disabled:bg-gray-600"
            [ngStyle]="{ backgroundColor: isListening ? 'red' : '#1F2937' }"
            [attr.aria-label]="
              isListening ? 'Stop listening' : 'Start listening'
            "
          >
            <div
              class="w-8 h-8 bg-red-500 rounded-md text-white flex items-center justify-center"
            >
              ■
            </div>
          </button>
        </div>
      </div>

      <!-- Right Panel: Chat -->
      <div class="col-span-2 rounded-r-xl flex flex-col theme-card h-full">
        <div class="p-4 border-b border-gray-700 flex-shrink-0">
          <h3 class="text-lg font-semibold text-center theme-gradient-text">
            Interview Chat
          </h3>
          @if (error) {
          <div class="text-sm text-red-400 text-center mt-2">{{ error }}</div>
          }
        </div>

        <div
          #chatContainer
          class="flex-1 overflow-y-auto p-4 chat-scroll-container"
          style="max-height: calc(70vh - 200px)"
        >
          <div class="space-y-4">
            <ng-container *ngFor="let item of transcript; trackBy: trackById">
              @if (item.speaker === 'feedback') {
              <div
                class="max-w-md mx-auto p-3 rounded-lg bg-yellow-900/50 border border-yellow-700 text-yellow-200 my-4"
              >
                <p class="text-sm text-gray-700">
                  <span class="font-bold">Feedback:</span> {{ item.text }}
                </p>
              </div>
              } @else {
              <div
                class="flex items-start gap-3"
                [ngClass]="{
                  'justify-end': item.speaker === 'user',
                  'justify-start': item.speaker === 'ai'
                }"
              >
                @if(item.speaker === 'ai'){
                <div
                  class="w-8 h-8 rounded-full bg-gray-900 border border-gray-600 flex items-center justify-center font-bold text-sm text-blue-400"
                >
                  AI
                </div>
                }
                <div
                  class="max-w-md p-3 rounded-lg shadow-md"
                  [ngClass]="{
                    'bg-blue-600 text-white rounded-br-none':
                      item.speaker === 'user',
                    'bg-gray-700 text-gray-200 rounded-bl-none':
                      item.speaker === 'ai'
                  }"
                >
                  <p class="text-sm leading-relaxed">{{ item.text }}</p>
                </div>
              </div>
              }
            </ng-container>

            @if (aiStatus === 'thinking') {
            <div
              class="flex items-start gap-3 justify-start"
              id="ai-thinking-indicator"
            >
              <div
                class="w-8 h-8 rounded-full bg-gray-900 border border-gray-600 flex items-center justify-center font-bold text-sm text-blue-400"
              >
                AI
              </div>
              <div
                class="max-w-md p-3 rounded-lg bg-gray-700 text-gray-200 rounded-bl-none flex items-center space-x-2"
              >
                <div
                  class="w-6 h-6 border-t-2 border-b-2 border-indigo-500 rounded-full animate-spin"
                  role="status"
                ></div>
                <span class="text-sm text-gray-400">Thinking...</span>
              </div>
            </div>
            }
          </div>
        </div>

        <div class="p-4 border-t border-gray-700 flex-shrink-0">
          @if (recognitionError) {
          <div class="text-sm text-red-400 mb-2">{{ recognitionError }}</div>
          } @if (aiStatus === 'speaking') {
          <div class="flex items-center justify-center gap-3 p-2">
            <div class="w-6 h-6 relative flex items-center justify-center">
              <div
                class="w-full h-full rounded-full bg-blue-500/50 animate-ping absolute"
              ></div>
              <div class="w-3 h-3 rounded-full bg-blue-500"></div>
            </div>
            <span class="text-sm text-gray-400">AI is speaking...</span>
          </div>
          }

          <button
            (click)="endInterview()"
            class="w-full py-3 px-4 bg-red-600 hover:bg-red-700 rounded-lg font-semibold text-white"
          >
            End Interview & Get Report
          </button>
        </div>
      </div>
    </div>

    <!-- Fullscreen Exit Warning Modal -->
    @if (showFullscreenExitWarning) {
    <div
      class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50"
    >
      <div
        class="bg-gray-800 border border-gray-600 rounded-lg p-6 max-w-md mx-4"
      >
        <div class="text-center">
          <div
            class="w-12 h-12 mx-auto mb-4 bg-yellow-600 rounded-full flex items-center justify-center"
          >
            ⚠️
          </div>
          <h3 class="text-xl font-bold text-black mb-2">
            Interview Must Be In Fullscreen
          </h3>
          <p class="text-gray-300 mb-6">
            For the best interview experience and to maintain focus, this
            interview must be conducted in fullscreen mode. Exiting fullscreen
            will end the interview without generating a report.
          </p>
          <div class="flex gap-3 justify-center">
            <button
              (click)="confirmExitInterview()"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors"
            >
              Exit Interview
            </button>
            <button
              (click)="continueInterviewInFullscreen()"
              class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
            >
              Continue in Fullscreen
            </button>
          </div>
        </div>
      </div>
    </div>
    } }

    <!-- REPORT VIEW -->
    @if (currentView === AppView.REPORT) {
    <div class="w-full rounded-lg p-6 bg-gray-800" style="min-height: 70vh">
      @if (isLoading) {
      <div class="w-full h-full flex flex-col items-center justify-center">
        <div
          class="w-10 h-10 border-t-2 border-b-2 border-indigo-500 rounded-full animate-spin"
          role="status"
        ></div>
        <h4 class="text-2xl font-bold mt-4">Generating Your Report...</h4>
        <p class="text-gray-300 mt-2">
          The AI is analyzing your performance. This may take a moment.
        </p>
      </div>
      } @else if (!isLoading && error) {
      <div
        class="w-full h-full flex flex-col items-center justify-center text-center"
      >
        <h4 class="text-2xl font-bold text-red-400">An Error Occurred</h4>
        <p class="text-gray-300 mt-2">{{ error }}</p>
        <button
          (click)="startAgain()"
          class="mt-6 bg-indigo-600 text-white font-bold py-2 px-4 rounded"
        >
          Try Again
        </button>
      </div>
      } @else if (!isLoading && !error && report) {
      <ng-container>
        <div class="flex justify-between items-center mb-6">
          <h4 class="text-3xl font-bold">Performance Report</h4>
          <button
            (click)="startAgain()"
            class="bg-indigo-600 text-white font-bold py-2 px-4 rounded"
          >
            Start New Interview
          </button>
        </div>

        <div class="space-y-6">
          <div class="bg-gray-900 p-4 rounded-lg">
            <h5 class="text-xl font-semibold text-indigo-300 mb-2">
              Overall Summary
            </h5>
            <p class="text-gray-200">{{ report!.overallSummary }}</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-900 p-4 rounded-lg">
              <h5 class="text-xl font-semibold text-green-400 mb-2">
                Strengths
              </h5>
              <ul class="list-disc list-inside space-y-1 text-gray-200">
                <li *ngFor="let s of report!.strengths">{{ s }}</li>
              </ul>
            </div>
            <div class="bg-gray-900 p-4 rounded-lg">
              <h5 class="text-xl font-semibold text-yellow-400 mb-2">
                Areas for Improvement
              </h5>
              <ul class="list-disc list-inside space-y-1 text-gray-200">
                <li *ngFor="let a of report!.areasForImprovement">{{ a }}</li>
              </ul>
            </div>
          </div>

          <div>
            <h5 class="text-2xl font-semibold mb-2">
              Question by Question Analysis
            </h5>
            <div class="space-y-3">
              <div
                class="bg-gray-900 p-4 rounded-lg"
                *ngFor="let item of report!.questionByQuestionAnalysis"
              >
                <div class="flex justify-between items-start mb-2">
                  <p class="font-bold flex-1 pr-4">Q: {{ item.question }}</p>
                  <div
                    [ngClass]="getScoreColor(item.score)"
                    class="text-2xl font-bold"
                  >
                    {{ item.score }}/10
                  </div>
                </div>
                <p
                  class="text-sm text-gray-400 mb-2 italic bg-gray-800 p-3 rounded"
                >
                  Your Answer: "{{ item.userAnswer }}"
                </p>
                <p class="text-sm text-gray-300">
                  <span class="font-semibold text-indigo-300">Feedback:</span>
                  {{ item.feedback }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
      }
    </div>
    }
  </div>
</div>
